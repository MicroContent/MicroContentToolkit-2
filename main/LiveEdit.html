<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>LiveEditTestHost</title>
    <!--Codemirror basics-->
    <script src="../codemirror-5.63.3/lib/codemirror.js"></script>
    <link rel="stylesheet" href="../codemirror-5.63.3/lib/codemirror.css">
    <!--Codemirror themes-->
    <link rel="stylesheet" href="../codemirror-5.63.3/theme/dracula.css">
    <!--Codemirror modes-->
    <script src="../codemirror-5.63.3/mode/xml/xml.js"></script>
    <script src="../codemirror-5.63.3/mode/css/css.js"></script>
    <script src="../codemirror-5.63.3/mode/javascript/javascript.js"></script>
    <script src="../codemirror-5.63.3/mode/htmlmixed/htmlmixed.js"></script>
    <!--Codemirror addons-->
    <link rel="stylesheet" href="../codemirror-5.63.3/addon/hint/show-hint.css">
    <script src="../codemirror-5.63.3/addon/hint/show-hint.js"></script>
    <script src="../codemirror-5.63.3/addon/hint/html-hint.js"></script>
    <script src="../codemirror-5.63.3/addon/hint/css-hint.js"></script>
    <script src="../codemirror-5.63.3/addon/hint/xml-hint.js"></script>
    <script src="../codemirror-5.63.3/addon/hint/javascript-hint.js"></script>
    <script src="../codemirror-5.63.3/addon/edit/closetag.js"></script>
    <script src="../codemirror-5.63.3/addon/edit/closebrackets.js"></script>
    <script src="../codemirror-5.63.3/addon/edit/matchtags.js"></script>
    <script src="../codemirror-5.63.3/addon/fold/xml-fold.js"></script>
    <!--other-->
    <link rel="stylesheet" href="../css/test.css">
    <script src="../js/script.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="../node_modules/seamless/build/seamless.parent.min.js"></script>
    
    <style>
        .CodeMirror {
            height: 100%;
            width: 100%;
            position: absolute
        }
    </style>


    <!-- seamless related functions -->
    <script type="text/javascript">
        // variables to handle the data we get from the editor later
        var editorKeys;
        var editorValues;
        var editorObject;
        // window.onload = function() {
        //     var child1 = document.getElementById('code_result_viewer');
        //     var child2 = document.getElementById('code_result_editor');
        //     // Turns the iframe into a seamless iframe.
        //     window.seamless(child1);
        //     window.seamless(child2);

            
        //     child2.receive(function(data) {
        //         switch(data.type) {
        //             case 'toViewer':
        //             if (data.hasOwnProperty('title')) {
        //                 titleV = data.title;
        //             }
        //             if (data.hasOwnProperty('question')) {
        //                 questionV= data.question;
        //             }
        //             console.log("got: ",titleV,questionV)
        //             break;
        //         }
        //     });
        //     window.sendToChild = function(event) {
        //         event.preventDefault();
        //         console.log("send:",titleV,questionV)
        //         child1.send({
        //             type: 'setContent',
        //             title: titleV,
        //             question: questionV
        //             });
        //         };

        //     window.injectStyles = function(event) {
            
        //         event.preventDefault();
        //             child1.send({
        //                 type: 'seamless_styles',
        //                 data: [document.getElementById('childstyles2').value]
        //             });
        //         };
        //     };
        

        // multi purpose function
        function child2load(){

            //make the editor into seamless iframe
            var child2 = document.getElementById('code_result_editor');
            window.seamless(child2);

            //get infor from the editor when the function is called
            child2.receive(function(data) {
                //type has to be toViewer
                switch(data.type) {
                    case 'toViewer':
                    //the data we get is in object format; to be able to handle any amount of input we use the data as it is; we only get rid of unnecessary data from the end
                    editorKeys=Object.keys(data).slice(0,Object.entries(data).length-1);
                    editorValues=Object.values(data).slice(0,Object.entries(data).length-1);
                    //combine the two arrays into a nested array for easier handling
                    editorObject=editorKeys.map(function(e, i) {
                        return [e, editorValues[i]];
                    });
                    };
                    console.log("got: ",Object.values(data).slice(0,Object.entries(data).length-1),Object.keys(data).slice(0,Object.entries(data).length-1))
                    //display easy to interpret and user friendly but accurate data to the user
                    loadData()
                    
                });
            };  
            
        // document.getElementById("chload").addEventListener("click",child1load)
        //multi purpose function
        function child1load(){
            //make viewer into seamless iframe
            var child1 = document.getElementById('code_result_viewer');
            window.seamless(child1);

            //send data to the viewer; the data we get from the editor
            window.sendToChild = function(event) {
                event.preventDefault();
                    child1.send({
                        type: 'setContent',
                        //send the whole array to handle any amount of input data; the viewer plugin has to unpack the data however they see fit
                        main: [editorObject]        
                });
                console.log("sending",editorObject)
            };
        
            //inject a style to the viewer to represent the learning website 
            window.injectStyles = function(event) {
            
                event.preventDefault();
                    child1.send({
                        type: 'seamless_styles',
                        //get the data from the field where the style got copied
                        data: [document.getElementById('childstyles2').value]
                    });
                };
        };
        
        
        //make the object into a prettier form and display it to the user to have some chance for debugging
        function loadData(){
            var dataout = document.getElementById("datatoviewer")
            var niceout=JSON.stringify(editorObject);
            dataout.innerText=niceout

        };

    </script>

</head>

<body>

    <!-- editor related buttons showed on the right side of the page -->
    <div class="grid-container">
        <div class="Buttons">
            <div class="Editor-Section">

                <h2>Editor</h2>
                <input id="first_i" type="file">
                <!-- load the file into the codemirror code editor -->
                <button onclick="loadFileAsText()">Load the first editor</button>
                <!-- save the codemirror edited file to your computer -->
                <button type="button" id="save1" onclick="saveTextAsFile()">Save editor plugin to file</button>

                <!-- alternatively enter a url to load a file -->
                <br><br>
                <label>Src-Code into Editor Section</label>
                <input type="text" placeholder="Enter URL..." id="url-editor-input">
                <button id="url-editor" type="button" onclick="getSrcintoEditor()">Load Editor-CodeMirror</button>

            </div>


            <div id="filler"></div>
            <div id="filler"></div>


            <div class="Viewer-Section">

                <h2>Viewer</h2>
                <input id="second_i" type="file">
                <!-- load the file into the codemirror viewer code editor -->
                <button onclick="loadFileAsText2()">Load the second editor</button>
                <!-- save the codemirror edited file to your computer -->
                <button type="button" id="save2" onclick="saveTextAsFile2()">Save viewer plugin to file</button>

                <!-- alternatively enter a url to load a file -->
                <br><br>
                <label>Src-Code into Viewer Section</label>
                <input type="text" placeholder="Enter URL..." id="url-viewer-input">
                <button id="url" type="button" onclick="getSrcintoViewer()">Load Viewer-CodeMirror</button>

                <br><br>
                
            </div>

            <div id="filler"></div>
            <div id="filler"></div>

            <div class="Injection-Section">

                <h2>Style Injection</h2>
                <!--seamless injection-->
                <label for="url">Open Stylesheet</label><br>
                
                <input style="width: auto;" placeholder="Enter CSS's URL..." type="file" id="childstyles"><br>
                <!-- placeholder textfield for textual style description -->
                <input id="childstyles2" type="text" placeholder="Enter a style">
                <!-- call the seamless function to inject style -->
                <button type="button" style="width: auto;" onclick="injectStyles(event)">Submit</button>
                <!-- <a href="#" id="injectstyles" onclick="injectStyles(event)" class="button postfix">Submit</a> -->

                <!-- script placed here because it was throwing errors elsewhere
                this reads the stylesheet file converts it and places it in the placeholder field to be injected -->
                <script>
                    //reading file
                    document.getElementById("childstyles").addEventListener("change", readFileAsString)
                    function readFileAsString() {
                        f=document.getElementById('childstyles')
                        var files = f.files;
                        if (files.length === 0) {
                            console.log('No file is selected');
                            return;
                        };
                
                        var reader = new FileReader();
                        //placing file content to placeholder to be submitted
                        reader.onload = function() {
                            console.log(reader.result) 
                            var  outp= reader.result;
                            var fin=document.getElementById('childstyles2');
                            fin.value=outp;
                        };
                        reader.readAsText(files[0]);
                        
                    };
                </script>

            </div>


        <!-- live editors -->
        </div>
        <div class="Edit-editor" id="editor1"
            style="position:relative;border: 1px rgb(0, 17, 255) solid; margin: 0.5%;">
            <textarea id="live" class="form-control">Upload to change editor...</textarea>
            <!-- script for codemirror implementation -->
            <script>
                var editor = CodeMirror.fromTextArea
                    (document.getElementById('live'), {
                        mode: "htmlmixed",
                        theme: "dracula",
                        lineNumbers: true,
                        autoCloseTags: true,
                        extraKeys: { "Ctrl-Space": "autocomplete" },
                        autoCloseBrackets: true,
                        matchTags: true
                    });

            </script>

        </div>


        <!-- viewer live editor -->
        <div class="Edit-viewer" id="editor2"
            style="position:relative; border: 1px rgb(0, 17, 255) solid; margin: 0.5%;">
            <textarea id="live2" class="form-control">Upload to change viewer...</textarea>
            <!-- making codemirror -->
            <script>
                var editor2 = CodeMirror.fromTextArea
                    (document.getElementById('live2'), {
                        mode: "htmlmixed",
                        theme: "dracula",
                        lineNumbers: true,
                        autoCloseTags: true,
                        extraKeys: { "Ctrl-Space": "autocomplete" },
                        autoCloseBrackets: true,
                        matchTags: true

                    });

            </script>


        </div>


        <!-- editor part -->
        <div class="Editor" id='editor' style=" border: 1px rgb(0, 17, 255) solid; margin: 0.5%; overflow: scroll">
            <div class="panel-heading">
                <h2>Editor</h2>
                <!-- button outside of iframe to call functions that make the node hosting part happen in the background and transform the iframe into seamless -->
                <button class="btn btn-raised btn-info" onclick="reloadEditor(); child2load()">Reload Editor</button>
            </div>
            <div class="panel-body" id="editor_container"></div>
            <!-- iframe gets the source from user input -->
            <iframe id="code_result_editor" style="width:95%; height:80%" scrolling="yes" src="" ></iframe>

        </div>



        <!-- data section -->
        <div class="Data" id='data' style="border: 1px rgb(0, 17, 255) solid; margin: 0.5%; overflow: scroll">
            <div class="panel-heading">
                <h2>Data</h2>
                <p>Visual representation of the data</p>
                <!-- send data got from the editor to the viewer -->
                <button type="button" style="width: auto;" onclick="sendToChild(event)">Send data to viewer</button>
                <!-- <a href="#" id="sendToChild" onclick="sendToChild(event)" class="button postfix">Load Data from Editor</a> -->
            </div>
            <div class="panel-body">
                <!-- <p id="datatoviewer"></p> -->
                <!-- here comes the data from the editor -->
                <textarea id="datatoviewer" style="width: 80%; min-height: 150px" disabled="disabled"></textarea>
            </div>
        </div>



        <!-- viewer section -->
        <div class="Viewer" id='viewer' style=" border: 1px rgb(0, 17, 255) solid; margin: 0.5%; overflow: scroll" >
            <div class="panel-heading">
                <h2>Viewer</h2>
                <!-- button outside of iframe to call functions that make the node hosting part happen in the background and transform the iframe into seamless -->
                <button id='chload' class="btn btn-raised btn-info" onclick="reloadViewer(); child1load()">Reload Viewer</button>
            </div>
            <div class="panel-body" id="viewer_container"></div>
            <br>
            
            <!-- iframe gets the source from user input -->
            <iframe id="code_result_viewer" style="width:95%; height:80%" scrolling="yes"  src=""></iframe>

        </div>
    </div>
    
</body>

</html>